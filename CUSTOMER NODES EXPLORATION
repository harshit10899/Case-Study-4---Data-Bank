-------------A. Customer Nodes Exploration--------------  

------------How many unique nodes are there on the Data Bank system?------

  SELECT DISTINCT(NODE_ID) FROM CUSTOMER_NODE
  ORDER BY 1 ASC;
  
 SELECT COUNT(DISTINCT(NODE_ID)) AS "DISTINCT_NODE" FROM CUSTOMER_NODE;
 
 
 -----5 DISTINCT NODES 1,2,3,4,5-------
 
 --------------What is the number of nodes per region?----------
 
 WITH CTE1 AS
 (SELECT A.REGION_ID,A.NODE_ID,B.REGION_NAME FROM 
 CUSTOMER_NODE AS A 
 LEFT JOIN 
 REGIONS AS B
 ON A.REGION_ID = B.REGION_ID)
 SELECT REGION_NAME,COUNT(NODE_ID) AS "NUMBER_OF_CUSTOMERS" FROM CTE1
 GROUP BY 1
 ORDER BY 2 DESC;
 
 ----MOST NODES IN AUSTRALIA AND LEAST IN EUROPE----
 
 ----------How many customers are allocated to each region?-------
 
 WITH CTE1 AS
 (SELECT A.CUSTOMER_ID,B.REGION_NAME FROM 
 CUSTOMER_NODE AS A 
 LEFT JOIN 
 REGIONS AS B
 ON A.REGION_ID = B.REGION_ID)
 SELECT REGION_NAME,COUNT(CUSTOMER_ID) AS "NUMBER_OF_CUSTOMER" FROM CTE1
 GROUP BY 1
 ORDER BY 2 DESC;
 
 
------Australia 770

-----America 735

----Africa 714

---Asia 665
  
--Europe 616

----------------------How many days on average are customers reallocated to a different node?---------

SELECT SUM(CASE
            WHEN REGION_ID = NODE_ID THEN 1
            ELSE 0
            END) AS "SAME_ALLOCATION",SUM(CASE
            WHEN REGION_ID != NODE_ID THEN 1
            ELSE 0
            END) AS "REALLOCATION" FROM CUSTOMER_NODE;

-- 670 SAME ALLOCATION MENAS NODE ID AND REGION ID ARE SAME
-- 2830 REALLOCATION WHICH MEANS NODE ID AND REGION ID ARE NOT SAME

WITH CTE1 AS(
SELECT *,DATEDIFF(DAY, START_DATE::DATE, END_DATE::DATE) AS "REALLOCATION_DAYS" FROM CUSTOMER_NODE WHERE REGION_ID != NODE_ID
ORDER BY 2 ASC)
SELECT ROUND(AVG(REALLOCATION_DAYS)) FROM CTE1;


----- AVERAGE REALLOCATION DAYS ARE 50-------


-----What is the median, 80th and 95th percentile for this same reallocation days metric for each region---


WITH CTE1 AS(
SELECT *,DATEDIFF(DAY, START_DATE::DATE, END_DATE::DATE) AS "REALLOCATION_DAYS" FROM CUSTOMER_NODE WHERE REGION_ID != NODE_ID
ORDER BY 2 ASC)
SELECT ROUND(MEDIAN(REALLOCATION_DAYS)) "MEDIAN OF REAALOCATION DAYS" FROM CTE1;


---- MEDIAN = 17





WITH CTE1 AS(
SELECT *,DATEDIFF(DAY, START_DATE::DATE, END_DATE::DATE) AS "REALLOCATION_DAYS" FROM CUSTOMER_NODE WHERE REGION_ID != NODE_ID
ORDER BY 2 ASC)
SELECT
  APPROX_PERCENTILE(REALLOCATION_DAYS, 0.8) AS "80th_percentile",
  APPROX_PERCENTILE(REALLOCATION_DAYS, 0.95) AS "95th_percentile"
FROM
  CTE1;

-- 80TH PERCENTILE 28
-- 95TH PERCENTILE 267
